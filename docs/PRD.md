# Product Requirements Document (PRD): find_smth_in_gitlab

## 1. Описание продукта

**find_smth_in_gitlab** — CLI-инструмент для автоматизированного поиска по содержимому файлов из групп проектов GitLab на основе динамического списка целевых объектов из NetBox и заданного критерия поиска (регулярного выражения). Скрипт предназначен для масштабируемого аудита сетевой инфраструктуры с использованием корпоративных репозиториев.

---

## 2. Контекст/мотивация

- Аудит и анализ состояния устройств и их параметров по содержимому файлов, выгруженных в структуре "один девайс — один проект" в GitLab.
- Минимизация ручного поиска по множеству репозиториев и поддержка стандартных задач инвентаризации.
- Применимость в CI/CD или автоматических заданиях (cron/CI pipeline).

---

## 3. Ключевые архитектурные решения и особенности

### 3.1. Единая группа с множеством проектов устройств

- В одном namespace GitLab (группа, например, `netconfigs`) для каждого устройства создаётся свой проект с файловой историей.
- Имя проекта обычно совпадает с hostname устройства (или другим уникальным атрибутом, выбираемым настройкой).
- Поиск всегда ведётся по реальному файлу внутри каждого отдельного проекта: формат пути — `"group/project"`.

### 3.2. Поддержка сложных фильтров по данным NetBox

- Список устройств генерируется динамически по фильтруемым параметрам NetBox (путь объекта, фильтры — в том числе список значений в формате YAML).
- Архитектура полностью разделяет логику взаимодействия с NetBox (выносится в кастомный модуль).

### 3.3. Жёсткое разделение терминологии и ответственности

- Скрипт и документация принципиально не используют слово “конфигурация” для файлов из GitLab, чтобы не создавать путаницу с YAML-конфигами самого инструмента.
- Для исходных файлов из проектов GitLab используются выражения: “файл устройства”, “файл из репозитория”, “исходный файл из проекта”.

### 3.4. Требования к правам доступа в GitLab

- Для доступа к содержимому файлов требуется, чтобы роль пользователя была не ниже **Reporter** (Guest не подходит).
- Токен должен иметь scopes: `api`, `read_api`, `read_repository`.

### 3.5. Конфигурирование через YAML

- Вся бизнес-логика (что искать, где искать, с какими фильтрами) вынесена в отдельный YAML-конфиг.
- Конфиг должен находиться в папке `configs/`, имя задаётся пользователем как позиционный CLI-аргумент.
- Опциональные ключи (name, description) используются для удобства выдачи отчёта и идентификации задачи.

### 3.6. CLI-интерфейс и обработка файлов

- Пользователь указывает только имя задания (конфига) из `configs/`.
- Запуск:  
  `python find_smth_in_gitlab.py <имя_конфига_без_пути>`
- Листинг доступных аудитов:  
  `python find_smth_in_gitlab.py --list-configs`
- Скрипт сам подставляет расширение файла `.yaml` или `.yml`, если его нет.

### 3.7. Логика обхода проектов GitLab

- Для каждого устройства из выборки формируется путь `"group/hostname"` и делается API-запрос к GitLab, чтобы получить файл и выполнить поиск.
- Если проект или файл не найдены, пользователь явно увидит это в логе.
- Весь процесс независим от структуры или параметров файлов — все детали определяются только в YAML.

### 3.8. Масштабируемость

- Архитектура допускает гибкое расширение без изменения кода: добавление новых фильтров, групп, шаблонов поиска и др. — только через YAML и CI/CD-окружение.

---

## 4. Дальнейшее развитие

- **Контейнеризация**: подготовка Dockerfile и docker-compose для простого развертывания без сложной настройки окружения и зависимостей.

---

**NB:** Импорт, инициализация и требования к переменным окружения (например, `.env`, пути, scopes) полностью делегированы на сторонние модули (`gitlab_connector` и т.д.) и описываются в их документации/PRD.  
Данный скрипт работает с уже подготовленным окружением и не занимается самим импортом переменных окружения.